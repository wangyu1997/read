
[TOC]

---

## 消息认证码

消息认证码是一种确认完整性并进行认证的技术。输入包括任意长度的消息和一个发送者与接收者之间共享的密钥，输出固定长度的数据，称为MAC值。消息认证码是一种与密钥相关联的单向散列函数。

HMAC的步骤：

    密钥填充
    填充后的密钥与 ipad 的 XOR
    与消息组合
    计算散列值
    填充后的密钥与 opad 的 XOR
    与散列值组合
    计算散列值

防御重放攻击：序号、时间戳、nonce

## 数字签名

生成消息签名由消息发送者完成，根据消息内容计算数字签名的值，发送者认可该消息的内容。  
验证数字签名由消息接收者完成或者第三方验证者完成，检查该消息的签名是否真的属于发送者。  
**数字签名对签名密钥和验证密钥进行了区分，使用验证密钥是无法生成签名的。签名密钥只能由签名的人持有，而验证密钥则是任何需要验证签名的人都可以持有。**  
数字签名就是通过将公钥密码“反过来用”而实现的。  

公钥密码与数字签名的密钥使用方式：  

   |           |      私钥          |      公钥
   |  :---     |      :---          |      :---
   |公钥密码   |接收者解密时使用    |发送者加密时使用
   |数字签名   |签名者生成签名时使用|验证者验证签名时使用
   |谁持有密钥?|个人持有            |只要需要，任何人都可以持有

数字签名中同样会使用公钥和私钥组成的密钥对，这两个密钥的用法和公钥密码是相反的，即用私钥加密相当于生成签名，而用公钥解密则相当于验证签名。

直接对消息签名的方法：

    发送者用自己的私钥对消息进行加密
    发送者将消息和签名发送给接收者
    接收者用发送者的公钥对收到的签名进行解密
    接收者将签名解密后得到的消息与发送者直接发送的消息进行对比

对消息的散列值签名的方法：

    发送者用单向散列函数计算消息的散列值
    发送者用自己的私钥对散列值进行加密
    发送者将消息和签名发送给接收者
    接收者用发送者的公钥对收到的签名进行解密
    接收者将签名解密后的到的散列值与发送者直接发送的消息的散列值进行对比


对称密码与公钥密码的对比，以及消息认证码与数字签名的对比：

|            |对称密码      |公钥密码
|:---        |:---          |:---
|发送者      |用共享密钥加密|用公钥加密
|接收者      |用共享密钥解密|用私钥解密
|密钥配送问题|存在          |不存在，但公钥需要另外认证
|机密性      |O             |O

|            |消息认证码         |数字签名
|:---        |:---               |:---
|发送者      |用共享密钥计算MAC值|用私钥生成签名
|接收者      |用共享密钥计算MAC值|用公钥验证签名
|密钥配送问题|存在               |不存在，但公钥需要另外认证
|完整性      |O                  |O
|认证        |O(仅限通信对象双方)|O(可适用于任何第三方)
|防止否认    |X                  |O


数字签名无法解决的问题：公钥必须属于真正的发送者。


## 证书(为公钥加上数字签名)

步骤：

    Bob 生成密钥对
    Bob 在认证机构Trent注册自己的公钥
    认证机构Trent用自己的私钥对 Bob 的公钥施加数字签名并生成证书
    Alice 得到带有认证机构Trent的数字签名的 Bob 的公钥(证书)
    Alice 使用认证机构Trent的公钥验证数字签名，确认 Bob 的公钥的合法性
    Alice 用 Bob 的公钥加密消息并发送给 Bob
    Bob 用自己的私钥解密密文得到 Alice 的消息

公钥基础设施(PKI)：是为了能够更有效地运用公钥而制定的一系列规范和规格的总称。  

PKI组成要素：

    用户---使用PKI的人
    认证机构---颁发证书的人
    仓库---保存证书的数据库

用户：希望使用PKI注册自己的公钥的人，希望使用已注册的公钥的人。  

注册公钥的用户所进行的操作：

    生成密钥对(也可以由认证机构生成)
    在认证机构注册公钥
    向认证机构申请证书
    根据需要申请作废已注册的公钥
    解密接收到的密文
    对消息进行数字签名

使用已注册公钥的用户所进行的操作：

    将消息加密后发送给接收者
    验证数字签名

认证机构：是对证书进行管理的人。所进行的步骤如下：

    生成密钥对(也可以由用户生成)
    在注册公钥时对本人身份进行认证
    生成并颁发证书
    作废证书

仓库：是一个保存证书的数据库，PKI用户在需要时可以从中获取证书。

## 密钥

**Diffie-Hellman 密钥交换**  
通信双方仅通过交换一些可以公开的信息就能够生成出共享的秘密数字。  

步骤：

    Alice 向 Bob 发送两个质数 P 和 G
    Alice 生成一个随机数 A
    Bob 生成一个随机数 B
    Alice 将 G 的 A 次方mod P 这个数发送给 Bob
    Bob 将 G 的 B 次方mod P 这个数发送给 Alice
    Alice 用 Bob 发过来的数计算 A 次方并求mod P
    Bob 用 Alice 发过来的数计算 B 次方并求mod P

**基于口令的密码(PBE)**  
PBE加密过程：**生成KEK；生成会话密钥并加密；加密消息**  
PBE解密过程：**重建KEK；解密会话密钥；解密消息**

盐是用来防御字典攻击的。  
如何生成安全的口令：使用只有自己才能知道的信息、将多个不同的口令分开使用、有效利用笔记、理解口令的局限性、使用口令生成和管理工具。

## 随机数

用到随机数场景：生成密钥、生成密钥对、生成初始化向量(IV)、生成nonce、生成盐。  
随机性：不存在统计学偏差，是完全杂乱的数列(弱伪随机数)  
不可预测性：不能从过去的数列推测出下一个出现的数(强伪随机数)  
不可重现性：除非将数列本身保存下来，否则不能重现相同的数列(真随机数)

具体的伪随机数生成器：杂乱的方法、线性同余法、单向散列函数法、密码法、ANSI X9.17  


## SSL/TLS

**机密性问题；完整性问题；认证的问题**  
要确保机密性，可以使用对称密码。使用伪随机数生成器来生成密钥。使用公钥密码或Diffie-Hellman密码交换将对称密钥发送给通信对象。识别篡改，对数据进行认证，可以使用消息认证码。要对通信对象进行认证，可以使用对公钥加上数字签名所生成的证书。  

**TLS记录协议、TLS握手协议**  
**TLS记录协议**：负责使用对称密码对消息进行加密通信部分。使用了对称密码和消息认证码。负责消息的压缩、加密以及数据的认证。   
**TLS握手协议**：握手协议、密码规格变更协议、警告协议、应用数据协议。  
握手协议 负责生产共享密钥以及交换证书。生产共享密钥是为了进行密码通信，交换证书是为了通信双方相互进行认证。过程如下：

    ClientHello(客户端--->服务器) 可用的版本号、当前时间、客户端随机数、会话ID、可用的密码套件清单、可用的压缩方式清单。
    ServerHello(客户端<---服务器) 使用的版本号、当前时间、服务器随机数、会话ID、使用的密码套件、使用的压缩方式。
    Certificate(客户端<---服务器) 证书清单。首先发送的是服务器(发送方)的证书，然后会按顺序发送对服务器证书签名的认证机构的证书。客户端会对服务器发送过来的证书进行验证。
    ServerKeyExchange(客户端<---服务器) 当Certificate消息不足以满足需求时，服务器会通过ServerKeyExchange消息向客户端发送一些必要信息。
    CertificateRequest(客户端<---服务器) 用于服务器向客户端请求证书，进行客户端认证。服务器会向客户端发送下列信息---服务器能够理解的证书类型清单、服务器能够理解的认证机构名称清单。
    ServerHelloDone(客户端<---服务器) 表示从ServerHello消息开始的一系列消息的结束。
    Certificate(客户端--->服务器) 当服务器发送了CertificateRequest消息时，客户端会将自己的证书同Certificate消息一起发生给服务器。
    ClientKeyExchange(客户端--->服务器) 包含RSA时，发送经过机密的预备主密码；包含Diffie-Hellman密钥交换时，发送Diffie-Hellman的公开值。
    CertificateVerify(客户端--->服务器) 向服务器证明自己的确持有客户端证书的私钥。
    ChangeCipherSpec(客户端--->服务器) 密码规格变更协议的消息。
    Finished(客户端--->服务器) 确认握手协议是否正常结束，密码套件的切换是否正确。
    ChangeCipherSpec(客户端<---服务器) 服务器发送ChangeCipherSpec消息。
    Finished(客户端<---服务器) 服务器发送Finished消息。
    切换至应用数据协议。

握手协议完成了下列操作：

    客户端获得了服务器的合法公钥，完成了服务器认证
    服务器获得了客户端的合法公钥，完成了客户端认证(当需要客户端认证时)
    客户端和服务器生成了密码通信中使用的共享密钥
    客户端和服务器生成了消息认证码中使用的共享密钥

TLS握手协议汇总使用的密码技术：
密码技术      |作用
:---          |:---
公钥密码      |加密预备主密码
单向散列函数  |构成伪随机数生成器
数字签名      |验证服务器和客户端的证书
伪随机数生成器|生成预备主密码、根据主密码生成密钥(密码参数)、生成初始化向量

TLS记录协议中使用的密码技术：
密码技术         |作用
:---             |:---
对称密码(CBC模式)|确保片段的机密性
消息认证码       |确保片段的完整性并进行认证
认证加密(AEAD)   |确保片段的完整性和机密性并进行认证









