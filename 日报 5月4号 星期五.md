
---

### 寄存器

### 寄存器组有16个寄存器
  寄存器   |   描述
  :----:   |  :----:
  R0-R12   |  通用寄存器
  R13/SP   |  栈指针
  R14/LR   |  链接寄存器
  R15/PC   |  程序计数器

**13个通用寄存器**：R0-R7 低寄存器、R8-R12高寄存器。

**R13/SP 栈指针**：通过PUSH和POP操作实现栈存储访问。主栈指针(MSP)是默认的栈指针；进程栈指针(PSP)只用于线程模式。不跑嵌入式OS的情况下，PSP没必要使用。

**R14/LR 链接寄存器**：函数或子程序调用时返回地址的保存。某函数调用另一个函数或子程序，首先将LR数值保存在栈中，防止函数调用后，LR的当前值丢失。

**R15/PC程序计数器**：可读可写，读PC返回当前指令地址加4；写PC会引起跳转操作。

### 特殊寄存器

**程序状态寄存器**：
包括：应用PSR(APSR)、执行PSR(EPSR)、中断PSR(IPSR)。IPSR为只读的。

**PRIMASK、FAULTMASK和BASEPRI寄存器**
中断屏蔽寄存器，PRIMASK置位时，会阻止不可屏蔽中断和HardFault异常之外的所有中断异常，实际是将当前异常优先级提升为0。FAULTMASK置位时，会阻止不可屏蔽中断之外的所有中断异常，实际是将当前异常优先级提升为-1。BASEPRI会根据优先等级屏蔽异常或中断。BASEPRI为0时不起作用，非0时，会屏蔽具有相同或更低优先级的异常或中断。

**CONTROL寄存器**
    
    栈指针的选择(主栈指针/进程栈指针)
    线程模式的访问等级(特权/非特权)
    
运行在非特权等级的程序无法再切回特权等级。但可使用异常机制，在异常处理期间，处理程序可以清除nPRIV位，返回到线程模式后，处理器就会进入特权访问等级。

### 应用程序状态寄存器(APSR)

    整数运算的状态标志(N-Z-C-V位)
    饱和运算的状态标志(Q位)
    SIMD运算的状态标志(GE位)

---

# 存储器系统

**存储器系统特性**：4GB线性地址空间、架构定义的存储器映射、支持小端和大端的存储器系统、位段访问(可选)、写缓冲、存储器保护单元(MPU)、非对齐传输支持。

### 存储器映射

    0x00000000~0x1FFFFFFF CODE     0.5GB 主要用于程序代码，也用于异常向量表
    0x20000000~0x3FFFFFFF SRAM     0.5GB 主要用于数据存储器(如静态RAM)
    0x40000000~0x5FFFFFFF 外设     0.5GB 主要用于外设
    0x60000000~0x9FFFFFFF 外部RAM  1GB   主要用于外部存储器
    0xA0000000~0xDFFFFFFF 外部设备 1GB   主要用于外部设备
    0xE0000000~0xFFFFFFFF 系统     0.5GB 包括内置的中断控制器(NVIC)和调试部件在内的私有外设
        0xE0000000~0xE00FFFFF            私有外设总线(PPB)
            0xE000E000~0xE000EFFF        系统控制空间(SCS)


### 栈存储
后进先出的数据存储缓冲，使用PUSH指令往栈中存储数据以及POP指令从栈中提取数据。

栈可用于：执行函数时，临时存储数据的初始值，避免调用函数丢失数据；往函数或子程序中的信息传递；存储局部变量；中断异常产生时保存处理器状态和寄存器数值。

**在调用函数开始时，寄存器的内容可以通过PUSH指令保存在栈中，而后在函数调用结束时通过POP恢复为它们的初始值。**
   
---

### 异常和中断
异常会改变程序流，产生时处理器会暂停当前任务，转而执行异常处理程序。在异常处理执行完后，再继续正常地程序执行。

**嵌套向量中断控制器(NVIC)**
    
    灵活的异常和中断管理(脉冲中断请求、电平触发中断请求)
    支持嵌套异常/中断(抢占)
    向量化的异常/中断入口
    中断屏蔽(PRIMASK、FAULTMASK、BASEPRI)

#### 向量表
向量表为系统存储器内的字数据数组，每个元素都代表一个异常类型的起始地址。
向量表便宜寄存器(VTOR)可以对向量表重定位。

#### 复位和复位流程

复位类型：

    上电复位
    系统复位
    处理器复位

复位后以及处理器开始执行程序前，Cortex-M处理器会从存储器读出头两个字，头两个字为主栈指针(MSP)的初始值，以及代表复位处理起始地址的复位向量。处理器读出这两个字后，就会将这些数值赋给MSP和程序计数器(PC)。



































